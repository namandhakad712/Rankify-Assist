sequenceDiagram
    participant User as ðŸ‘¤ User (T5AI Board)
    participant Cloud as â˜ï¸ Tuya AI Workflow
    participant MCP_Browser as ðŸ³ Browser MCP (Docker/HF)
    participant MCP_Device as ðŸ³ Device MCP (Docker/HF)
    participant Vercel as ðŸš€ Cloud Bridge (Vercel)
    participant Supabase as ðŸ’¾ Supabase DB
    participant Extension as ðŸ§© Chrome Extension (Local)
    participant Browser as ðŸŒ Browser / Local PC

    rect rgb(230, 240, 255)
        Note over User, Cloud: ðŸ“¢ PHASE 1: TRIGGER
        User->>Cloud: Voice: "Open YouTube"
        Cloud->>Cloud: Speech-to-Text (STT) & Intent Analysis
    end

    rect rgb(230, 255, 240)
        Note over Cloud, Browser: âš¡ PHASE 2: BROWSER AUTOMATION (Direct Execution)
        Note right of Cloud: Intent: Browser
        Cloud->>MCP_Browser: execute_browser_command(...)
        
        Note right of MCP_Browser: ï¿½ Docker Container<br/>Tuya Client â†’ localhost:7860 â†’ FastAPI
        
        MCP_Browser->>Vercel: POST /api/execute
        Vercel->>Supabase: INSERT command (status=pending)
        
        loop Extension Polling (Every 3s)
            Extension->>Vercel: GET /api/poll
            Vercel->>Supabase: SELECT pending commands
        end
        
        Vercel-->>Extension: Return Command
        Extension->>Browser: Execute Script / Action
        Browser-->>Extension: Result
        
        Extension->>Vercel: POST /api/result
        Vercel->>Supabase: UPDATE command (result)
        Vercel-->>MCP_Browser: Return JSON Result
        MCP_Browser-->>Cloud: Action Success
        Cloud->>User: TTS: "Opened YouTube"
    end

    rect rgb(240, 255, 240)
        Note over Cloud, Browser: ðŸ  PHASE 3: DEVICE CONTROL (Via Extension/Bridge)
        Note right of Cloud: Intent: IoT Control
        Cloud->>MCP_Device: control_device(...)
        
        Note right of MCP_Device: ðŸ“¦ Docker Container<br/>Tuya Client â†’ localhost:7860 â†’ FastAPI
        
        MCP_Device->>Vercel: POST /api/execute (type=device_control)
        Vercel->>Supabase: INSERT command
        
        Vercel-->>Extension: Return Command (via poll)
        Extension->>Browser: Local Device Control / API
        Browser-->>Extension: Success
        
        Extension->>Vercel: POST /api/result
        Vercel-->>MCP_Device: Result
        MCP_Device-->>Cloud: Action Success
        Cloud->>User: TTS: "Device turned on"
    end
